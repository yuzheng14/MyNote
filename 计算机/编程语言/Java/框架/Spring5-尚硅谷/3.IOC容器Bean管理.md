# IoC容器Bean管理

## Bean管理是什么？

Bean管理指的是两个操作：Spring创建对象、Spring注入属性

## Bean管理操作

### 基于xml配置文件方式实现

#### 创建对象

```xml
<bean id="user" class="com.yuzheng14.springlearning.User"></bean>
```

- 使用`<bean>`标签实现对象创建

- `<bean>`中属性介绍

  > id：唯一标识
  >
  > class：类的全限定类名

- 创建对象时，默认执行无参构造方法

#### 注入属性

DI：依赖注入

##### 使用setter方式注入

###### 创建类，使用setter注入属性

```java
package com.yuzheng14.springlearning;

public class Book {
    private String name;
    private String author;

    public void setName(String name) {
        this.name = name;
    }

    public void setAuthor(String author) {
        this.author = author;
    }
}
```

###### Spring配置对象创建后配置属性注入

```xml
<bean id="book" class="com.yuzheng14.springlearning.Book">
	<property name="name" value="Head First Java"/>
	<property name="author" value="Kathy Sierra,Bert Bates"/>
</bean>
```

- 在bean标签内使用`<property>`标签实现属性注入

- `<property>`中属性介绍

  > name：类中属性的名称
  >
  > value：要注入的值

- 调用setter注入属性

##### 使用有参构造方式注入

###### 创建类，定义属性，创建属性对应有参构造方法

```java
package com.yuzheng14.springlearning;

public class Order {
    private String name;
    private String address;

    public Order(String name,String address){
        this.address=address;
        this.name=name;
    }
}
```

###### 在Spring配置文件中进行配置

```xml
<bean id="order" class="com.yuzheng14.springlearning.Order">
	<constructor-arg name="name" value="computer"/>
	<constructor-arg name="address" value="China"/>
</bean>
```

- 在bean标签内使用`<constructor-arg>`标签实现属性注入

- `<constructor-arg>`中属性介绍

  > name：构造器参数的名称
  >
  > index：构造器参数的顺序（和name二选一）（基数为0）
  >
  > value：要注入的值

- 调用setter注入属性

##### p名称空间注入（了解）

使用p名称空间，可以简化基于xml配置方式

###### 第一步  在配置文件的`<beans>`中添加p名称空间

修改后的`<beans>`

```xml
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:p="http://www.springframework.org/schema/p"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">
</beans>
```

###### 第二步  在`<bean>`标签里添加属性，进行属性注入

```xml
<bean id="book" class="com.yuzheng14.springlearning.Book" p:name="Head First Java" p:author="Kathy Sierra,Bert Bates"></bean>
```

#### xml注入其他类型属性

##### 字面量

- null值

  ```xml
  <bean id="book" class="com.yuzheng14.springlearning.Book">
  	<property name="name" value="Head First Java"/>
  	<property name="author" value="Kathy Sierra,Bert Bates"/>
  	<property name="address">
  		<null/>
  	</property>
  </bean>
  ```

  

- 属性值包含特殊符号

  - 把<>转义

    ```xml
    <property name="address" value="&lt;&lt;南京&gt;&gt"></property>
    ```

    | 符号 | 字段    | 释义         | 说明   |
    | ---- | ------- | ------------ | ------ |
    | \<   | \&lt;   | less than    | 小于号 |
    | \>   | \&gt;   | greater than | 大于号 |
    | \&   | \&amp   |              | 和     |
    | \'   | \&apos; |              | 单引号 |
    | \"   | \&quot; |              | 双引号 |

  - CDATA

    ```xml
    <property name="address">
        <value><![CDATA[<<南京>>]]></value>
    </property>
    ```

#### 注入外部Bean

##### 创建service类和dao类

```java
package com.yuzheng14.springlearning.service;

public class UserService {
    
    public void add(){
        System.out.println("service add......");
    }
}
```

```java
package com.yuzheng14.springlearning.dao;

public interface UserDao {
    
    public void update();
}
```

```java
package com.yuzheng14.springlearning.dao;

public class UserDaoImpl implements UserDao {
    
    @Override
    public void update() {
        System.out.println("dao update..........");
    }
}
```

##### 在service调用dao里面的方法

```java
package com.yuzheng14.springlearning.service;

import com.yuzheng14.springlearning.dao.UserDao;

public class UserService {
    private UserDao userDao;

    public void setUserDao(UserDao userDao) {
        this.userDao = userDao;
    }

    public void add(){
        System.out.println("service add......");
        userDao.update();
    }
}
```

##### 在Spring配置文件中进行配置

```xml
<bean id="userService" class="com.yuzheng14.springlearning.service.UserService">
	<property name="userDao" ref="userDao"/>
</bean>
<bean id="userDao" class="com.yuzheng14.springlearning.dao.UserDaoImpl"/>
```

其中`<property>`中使用`ref`属性来注入外部bean，值为`<bean>`的`id`值

#### 注入内部bean

##### 一对多关系

部门和员工

> 一个部门有多个员工  
> 一个员工属于一个部门
>
> 部门是一，员工是多

##### 在实体类中表现一对多关系

创建部门类和员工类

```java
package com.yuzheng14.springlearning.bean;

public class Department {

    private String name;

    public void setName(String name) {
        this.name = name;
    }
}

```

```java
package com.yuzheng14.springlearning.bean;

public class Staff {
    private String name;
    private String gender;

    private Department department;

    public void setDepartment(Department department) {
        this.department = department;
    }

    public void setName(String name) {
        this.name = name;
    }

    public void setGender(String gender) {
        this.gender = gender;
    }
}
```

##### 在Spring配置文件中进行配置

```xml
<bean id="staff" class="com.yuzheng14.springlearning.bean.Staff">
	<property name="name" value="Tom"/>
	<property name="gender" value="male"/>
	<property name="department">
    	<bean class="com.yuzheng14.springlearning.bean.Department">
	        <property name="name" value="Security"/>
        </bean>
	</property>
</bean>
```

在`<property>`标签中加入子标签`<bean>`（根据IDE的提示此标签不需要填写`id`属性）

#### 级联赋值

##### 内部Bean方式

```xml
<bean id="staff" class="com.yuzheng14.springlearning.bean.Staff">
	<property name="name" value="Tom"/>
	<property name="gender" value="male"/>
	<property name="department">
    	<bean class="com.yuzheng14.springlearning.bean.Department">
	        <property name="name" value="Security"/>
        </bean>
	</property>
</bean>
```

##### 外部Bean方式

```xml
<bean id="staff2" class="com.yuzheng14.springlearning.bean.Staff">
	<property name="name" value="David"/>
    <property name="gender" value="male"/>
	<property name="department" ref="department"/>
</bean>
<bean id="department" class="com.yuzheng14.springlearning.bean.Department">
	<property name="name" value="Finance"/>
</bean>
```

##### 第三种方式

```xml
<bean id="staff3" class="com.yuzheng14.springlearning.bean.Staff">
    <property name="name" value="David"/>
    <property name="gender" value="male"/>
    <property name="department" ref="department"/>
    <property name="department.name" value="Technology"/>
</bean>
<bean id="department2" class="com.yuzheng14.springlearning.bean.Department"/>
```

- 无需在部门`<bean>`内注入属性
- Department需要有对应属性的getter方法，否则报错

#### 注入集合类型属性

##### 新建学生类

```java
package com.yuzheng14.springlearning.collectiontype;

import java.util.List;
import java.util.Map;
import java.util.Set;

public class Student {
    private String[] curriculums;

    private List<String> list;

    private Map<String,String> map;

    private Set<String> set;

    public void setSet(Set<String> set) {
        this.set = set;
    }

    public void setList(List<String> list) {
        this.list = list;
    }

    public void setMap(Map<String, String> map) {
        this.map = map;
    }

    public void setCurriculums(String[] curriculums) {
        this.curriculums = curriculums;
    }
}
```

##### 在Spring配置文件中配置

###### 内部注入

```xml
<bean id="student" class="com.yuzheng14.springlearning.collectiontype.Student">
    <property name="curriculums">
        <array>
            <value>操作系统</value>
            <value>计算机组成原理</value>
            <value>数据结构</value>
            <value>C语言程序设计</value>
        </array>
    </property>
    <property name="list">
        <list>
            <value>张三</value>
            <value>法外狂徒</value>
        </list>
    </property>
    <property name="map">
        <map>
            <entry key="JAVA" value="java"/>
            <entry key="PYTHON" value="python"/>
        </map>
    </property>
    <property name="set">
        <set>
            <value>java</value>
            <value>python</value>
        </set>
    </property>
</bean>
```

###### 注入对象

修改Student类，加入以下语句

```java
	private List<Curriculum> curriculumList;
	
    public void setCurriculumList(List<Curriculum> curriculumList) {
        this.curriculumList = curriculumList;
    }
```

修改Spring配置文件

```xml
......
        <property name="curriculumList">
            <list>
                <ref bean="curriculum1"/>
                <ref bean="curriculum2"/>
            </list>
        </property>
......
    <bean id="curriculum1" class="com.yuzheng14.springlearning.bean.Curriculum">
        <property name="name" value="数据结构"/>
    </bean>
    <bean id="curriculum2" class="com.yuzheng14.springlearning.bean.Curriculum">
        <property name="name" value="算法设计与分析"/>
    </bean>
```

###### 提取集合注入

在Spring配置文件中引入名称空间util

```xml
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
                            http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd">
</beans>
```

使用util标签实现集合注入

```xml
<util:list id="bookList">
    <value>Head First Java</value>
    <value>Java Core</value>
    <value>c++ primer plus</value>
</util:list>
```

注入属性

```xml
<bean id="book" class="com.yuzheng14.springlearning.bean.Book">
    <property name="list" ref="bookList"/>
</bean>
```

### FactoryBean

#### Spring中Bean的类型

- 普通Bean
- 工厂Bean

#### 普通Bean

在配置文件中定义的Bean类型就是返回类型

#### 工厂Bean

在配置文件中定义的Bean类型可以和返回类型不一样

#### 做法

##### 创建MyBean类

```java
package com.yuzheng14.springlearning.factorybean;

import com.yuzheng14.springlearning.bean.Book;
import org.springframework.beans.factory.FactoryBean;
import org.springframework.context.ApplicationContext;
import org.springframework.context.support.ClassPathXmlApplicationContext;

public class MyBean implements FactoryBean<Book> {

    @Override
    public Book getObject() throws Exception {
        ApplicationContext context = new ClassPathXmlApplicationContext("bean5.xml");
        return context.getBean("book",Book.class);
    }

    @Override
    public Class<?> getObjectType() {
        return null;
    }
}

```

##### Spring配置文件中配置

```xml
<bean id="myBean" class="com.yuzheng14.springlearning.factorybean.MyBean"/>
```

##### 测试

```java
@Test
public void myBeanTest(){
    ApplicationContext context=new ClassPathXmlApplicationContext("bean6.xml");
    com.yuzheng14.springlearning.bean.Book book=context.getBean("myBean", com.yuzheng14.springlearning.bean.Book.class);

    System.out.println(book);
}
```

### Bean作用域

#### Bean实例类型

在Spring中，设置创建Bean实例是单实例还是多实例

#### 默认情况

在Spring里面，默认情况下，Bean是单实例对象

```java
ApplicationContext context=new ClassPathXmlApplicationContext("bean5.xml");
Book book1=context.getBean("book",Book.class);
Book book2=context.getBean("book",Book.class);
System.out.println(book1.getClass().getName() + "@" + Integer.toHexString(book1.hashCode()));
System.out.println(book2.getClass().getName() + "@" + Integer.toHexString(book2.hashCode()));
System.out.println(book1==book2);
```

输出结果

```
com.yuzheng14.springlearning.bean.Book@36ebc363
com.yuzheng14.springlearning.bean.Book@36ebc363
true
```

#### 设置实例类型

在Spring配置文件`<bean>`标签中由属性用于设置单实例还是多实例

##### `scope`属性的值

- 默认值，singleton，表示单实例对象
- prototype，表示多实例对象

##### 示例

```xml
<bean id="book" class="com.yuzheng14.springlearning.bean.Book" scope="prototype">
    <property name="list" ref="bookList"/>
</bean>
```

运行默认情况中的测试，输出结果

```
com.yuzheng14.springlearning.bean.Book@75d4a5c2
com.yuzheng14.springlearning.bean.Book@557caf28
false
```

#### singleton和prototype的区别



### Bean生命周期

### 基于注解方式实现
